<html>
<head>
<meta http-equiv="Content-Language" content="nl">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<title>GPIO Box REV 2</title>
<style>
h1 { 
    text-align: center;
}
.grid-container{
    padding: 15px;
    display: grid;
    justify-content: start;
    grid-gap: 10px;
    /* grid-auto-flow: column; */
    grid-template-columns: auto;
}
.grid-container > div{
    display: grid;
    grid-auto-flow: column;
    justify-content: left;
}
.labels > div{
    padding: 5px;
    width: 70px;
    height: 20px;
}
.step > div{
    padding: 5px;
    height: 20px;
    width: 50px;
}
.step > div > input{
    width: 35px;
}
#form_data{
    width: 500px;;
}
.hidden{
    /* visibility: hidden; */
}
.program{
    margin: 5px;
}
#program_ui{
    margin-left: 10px;
    width: 30px;
}
#speed_ui{
    margin-left: 22px;
    width: 50px;
}
</style>
</head>


<body>

<h1>GPIO Box REV 2</h1>

<div class="grid-container">
    <div class="program">Program Number: <input id="program_ui" onchange="update_program_number()"></div>
    <div class="program">Program Speed:  <input id="speed_ui" onchange="update_program_speed()"></div>
    <div id="step_inputs">
        <div class="Labels">
            <div>Break 1</div>
            <div>Break 2</div>
            <div>Break 3</div>
            <div>Break 4</div>
            <div>Break 5</div>
            <div>Break 6</div>
            <div>Break 7</div>
            <div>Break 8</div>
            <div>Speed 1</div>
            <div>Speed 2</div>
            <div>Speed 3</div>
            <div>Speed 4</div>
            <div>Speed 5</div>
            <div>Speed 6</div>
            <div>Speed 7</div>
            <div>Speed 8</div>
            <div>Analog 1</div>
            <div>Analog 2</div>
        </div>
        <div id="step_0" class="step">
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
        </div>
    </div>
</div>

<input type="button" value="Add Step" onclick="add_step()">
<input type="button" value="Remove Step" onclick="remove_step()"><br><br>

<input type="button" onclick="save_data()">

<form id="my_form" method="post" action="/" name="pins" onsubmit="save_data()">
    <input type="submit" value="Save program">
    <input type="text" id="program" class="hidden" name="program">
    <input type="text" id="speed" class="hidden" name="speed">
    <input id="form_data" type="text" name="step_0_data" value="00000000000000000000000000000000000000" class="hidden">
</form>

<script>
    function save_data(){
        var number_of_steps = document.getElementById("step_inputs").children.length - 1;                           // Count number of steps in program

        var inputs = document.getElementById("step_inputs");                                                        // Count number of checkboxes in HTML page (break / speed / analog inputs)
        inputs = inputs.getElementsByTagName("input");
        var value;                                                                                                  // Store the checkbox/speed signal value

        for (var x = 0; x < number_of_steps; x++){                                                                  // Loop through steps// var original = document.getElementById("my_form").children[x+2].value;                                   id = form_data, value="00000000000000000000000000000000000000"
            var original = document.getElementById("form_data").value;                                              // id = form_data, value="00000000000000000000000000000000000000"
            for (var i = 0; i < 8; i++) {                                                                           // Loop through break checkboxes in each step
                if (inputs[i+x*18].type === 'checkbox') {
                    if (inputs[i+x*18].checked){                                                                    // If checked = true, update from step data
                        value = inputs[i+x*18].value;    
                        original = replaceChar(original, '1', i);
                    }   
                }
            }
            for (var i = 0; i < 10; i++) {                                                                          // Loop through speed and analog text boxes in each step
                if (inputs[i+x*18+8].type === 'text') {
                    value = inputs[i+x*18+8].value;                                                                 // Save text box value
                    
                    for (var n = 2; n>=0; n--){                                                                     // Check each digit of value (0 - 255)
                        if (value[n]){                                                                              // If digit exists, update step data string
                            original = replaceChar(original, value[n], i*3+8+n);
                        }
                    }
                }
            }
            document.getElementById("my_form").children[x+3].value = original;
        }
    }

    function replaceChar(origString, replaceChar, index) {
        let firstPart = origString.substr(0, index);
        let lastPart = origString.substr(index + 1);
        
        let newString = firstPart + replaceChar + lastPart;
        return newString;
    }

    function add_step(){
        var count = document.getElementById("step_inputs").children.length;                                         // Check the number of steps in the HTML page

        if (count <= 20){                                                                                           // 20 = max steps allowed. Could change but will also have to change arduino code
            var original = document.getElementById("step_0");                                                       // Clone step inputs from step_0
            var clone = original.cloneNode(true);
            clone.id = "";
            original.parentNode.appendChild(clone);                                                                 // Appned cloned step to the end of step inputs div

            for (var i = 0; i < 8; i++){                                                                            // Reset break input signals
                clone.children[i].children[0].checked = false;
            }
            for (var i = 0; i < 10; i++){                                                                           // Reset speed and analog signals
                clone.children[i+8].children[0].value = "0";
            }

            var original_data = document.getElementById("form_data");                                               // Clone form data from step_0
            var clone_data = original_data.cloneNode(true);
            clone.id = "";
            clone_data.setAttribute("name","step_" + (count - 1) + "_data");

            clone_data.value = "00000000000000000000000000000000000000";                                            // Reset data to zeros

            original_data.parentNode.appendChild(clone_data);                                                       // Add cloned inputs to HTML page
        }
    }

    function remove_step(){
        var count = document.getElementById("step_inputs").children.length;                                         // CHeck the number of steps in the HTML page

        if (count > 2){                                                                                             // Leave at least one step on HTML page
            let input = document.getElementById("step_inputs");                                                     // Remove inputs
            input.removeChild(input.lastChild);

            let data = document.getElementById("my_form");                                                          // Remove step data
            data.removeChild(data.lastChild);   
        }
    }

    function update_program_number(){
        var program_number = document.getElementById("program_ui").value;
        document.getElementById("program").value = program_number;
    }

    function update_program_speed(){
        var program_speed = document.getElementById("speed_ui").value;
        document.getElementById("speed").value = program_speed;
    }
</script>
</body>
</html>