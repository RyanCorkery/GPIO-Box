<html>
<head>
<meta http-equiv="Content-Language" content="nl">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<title>GPIO Box REV 2</title>
<style>
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[type=number] {                       
  -moz-appearance: textfield;
}
body{
    display: flex;
    flex-direction: column;
}
h1 { 
    margin-top: 0;
    text-align: center;
    border-bottom: 2px solid darkslategray;
}
#list_form{
    margin-bottom: 0;
}
.grid-container{
    padding: 15px;
    display: grid;
    justify-content: start;
    grid-gap: 10px;
    grid-template-columns: auto;
}
.grid-container > div{
    display: grid;
    grid-auto-flow: column;
    justify-content: left;
}
.speed_input{
    margin-right: 5px;
}
.labels > div{
    padding: 5px;
    width: 70px;
    height: 20px;
}
.step{
    border-left: 1px solid cadetblue;
}
.step_label, #step_title{
    border-bottom: 2px solid gray;
}
.step > div{
    margin: 0 0 0 0;
    padding: 5px;
    height: 20px;
    width: auto;
}
.step_label{
    text-align: center;
}
.step > div > input{
    width: 40px;
    margin: auto;
}
#my_form{
    display: flex;
    flex-direction: column;
}
#form_data{
    width: 500px;;
}
.step_button{
    width: 200px;
    margin: 5px;
}
.hidden{
    visibility: hidden;
}
.program{
    margin: 5px 5px 0 0;
}
#program_ui{
    margin-left: 10px;
    width: 30px;
}
#speed_ui{
    margin-left: 22px;
    width: 50px;
}
.step_label{
    margin-left: 15px;
}
#description{
    margin: 5px;
    display: flex;
    width: auto;
}
#page_name {
    visibility: hidden;
}
</style>
</head>


<body id="page_name">

<h1>GPIO BOX REV 2</h1>

<form id="list_form" method="post" action="/">
    <input type="submit" name="list_form" value="Click to view the list of saved programs">
</form>

<form id="program_load" method="post" action="/" style="display: none;">
    <input type="text" value="" id="program_submit" name="program_load">
    <input type="submit">
</form>

<div class="grid-container">
    <div class="program"><label>Program Number:</label><input type="number" id="program_ui" value="" onchange="update_program_number(this)"></div>
    <div class="program"><label>Program Speed:</label><input class="speed_input" type="number" id="speed_ui" value="" onchange="update_program_speed(this)">[ms], period of each step</div>
    <div id="step_inputs">
        <div class="Labels">
            <div id="step_title">Step #</div>
            <div>Break 1</div>
            <div>Break 2</div>
            <div>Break 3</div>
            <div>Break 4</div>
            <div>Break 5</div>
            <div>Break 6</div>
            <div>Break 7</div>
            <div>Break 8</div>
            <div>Speed 1</div>
            <div>Speed 2</div>
            <div>Speed 3</div>
            <div>Speed 4</div>
            <div>Speed 5</div>
            <div>Speed 6</div>
            <div>Speed 7</div>
            <div>Speed 8</div>
            <div>Analog 1</div>
            <div>Analog 2</div>
        </div>
        <div id="step_0" class="step">
            <div class="step_label">0</div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="number" value="0" onchange="limit_break(this)"></div>
            <div><input type="number" value="0" onchange="limit_break(this)"></div>
            <div><input type="number" value="0" onchange="limit_break(this)"></div>
            <div><input type="number" value="0" onchange="limit_break(this)"></div>
            <div><input type="number" value="0" onchange="limit_break(this)"></div>
            <div><input type="number" value="0" onchange="limit_break(this)"></div>
            <div><input type="number" value="0" onchange="limit_break(this)"></div>
            <div><input type="number" value="0" onchange="limit_break(this)"></div>
            <div><input type="number" value="0" onchange="limit_break(this)"></div>
            <div><input type="number" value="0" onchange="limit_break(this)"></div>
        </div>
    </div>
</div>

<div>
    <input class="step_button" type="button" value="Add Step" onclick="add_step(false)">
    <input class="step_button" type="button" value="Duplicate Last Step" onclick="add_step(true)">
</div>
<input class="step_button" type="button" value="Remove Last Step" onclick="remove_step()">

<input type="button" value="Delete Program" class="step_button" onclick="delete_program()">

<iframe name="iframe1" style="display:none;"></iframe>
<!-- <form id="my_form" method="post" action="/" name="pins" target="iframe1" onsubmit="save_data()"></form> -->
<form id="my_form" method="post" action="/" name="pins" target="iframe1">
    <label>Program description:</label><input type="text" value="" id="description" name="description" maxlength="100">Limit 100 characters<br>
    <input class="step_button" type="submit" value="Save program" onclick="save_data()">
    <input type="text" id="program" class="hidden" name="program" value="">
    <input type="text" id="speed" class="hidden" name="speed" value="">
    <input id="form_data" type="text" name="step_0_data" value="00000000000000000000000000000000000000" class="hidden">
</form>

<input type="text" id="program_list" class="hidden" value="01-02-21-">

<form id="delete_form" method="post" action="/">
    <input type="text" id="program_number_delete" value='' name="delete" hidden>
</form>

<script>
    function save_data(){
        // Check if program exists
        var program_number = document.getElementById("program_ui").value;
        var file_list = document.getElementById("program_list").value;
        // If no number is entered, return
        if (program_number == '') return;
        // if program exists 
        // alert, overwrite? Check IO box
        if (program_number.length == 1) program_number = '0' + program_number;
        if (file_list.includes(program_number)){
            if (program_number == "00") alert("Program 0 can not be modified");
            else {
                if (confirm("Program " + program_number + " exists. Overwrite program?")) document.getElementById("my_form").submit();
                alert("Program " + program_number + " Saved");
            }
        }
        else{
            var file_list = file_list.concat(program_number, "-");
            document.getElementById("program_list").value = file_list;
            document.getElementById("my_form").submit();
            alert("Program " + program_number + " Saved");
        }

        var number_of_steps = document.getElementById("step_inputs").children.length - 1;                           // Count number of steps in program

        var inputs = document.getElementById("step_inputs");                                                        // Count number of checkboxes in HTML page (break / speed / analog inputs)
        inputs = inputs.getElementsByTagName("input");
        var value;                                                                                                  // Store the checkbox/speed signal value

        for (var x = 0; x < number_of_steps; x++){                                                                  // Loop through steps// var original = document.getElementById("my_form").children[x+2].value; 
            var current_data = "00000000000000000000000000000000000000";
            for (var i = 0; i < 8; i++) {                                                                           // Loop through break checkboxes in each step
                if (inputs[i+x*18].type === 'checkbox') {
                    if (inputs[i+x*18].checked){                                                                    // If checked = true, update from step data
                        value = inputs[i+x*18].value;    
                        current_data = replaceChar(current_data, '1', i);
                    }   
                }
            }
            for (var i = 0; i < 10; i++) {                                                                          // Loop through speed and analog text boxes in each step
                if (inputs[i+x*18+8].type === 'number') {
                    value = inputs[i+x*18+8].value;                                                                 // Save text box value
                    // map value 0-20 -> 0->255
                    value = map_value(value);

                    for (var n = 2; n >= 0; n--){                                                                     // Check each digit of value (0 - 255)
                        if (value[n]){                                                                              // If digit exists, update step data string
                            current_data = replaceChar(current_data, value[n], i*3+8+n);
                        }
                    }
                }
            }
            document.getElementById("my_form").children[x+6].value = current_data;
        }

        var description = document.getElementById("description");
        if (description.value == '') description.value = ' ';
    }

    function replaceChar(origString, replaceChar, index) {
        let firstPart = origString.substr(0, index);
        let lastPart = origString.substr(index + 1);
        
        let newString = firstPart + replaceChar + lastPart;
        return newString;
    }

    function add_step(duplicate){
        var count = document.getElementById("step_inputs").children.length;                                         // Check the number of steps in the HTML page

        if (count <= 20){                                                                          
            if (duplicate) var original = document.getElementById("step_inputs").children[count-1];                 // Clone last step
            else var original = document.getElementById("step_inputs").children[1];                                 // clone first step
            var clone = original.cloneNode(true);
            clone.id = count - 1;
            original.parentNode.appendChild(clone);                                                                 // Appned cloned step to the end of step inputs div

            if (!duplicate){
                for (var i = 0; i < 8; i++){                                                                            // Reset break input signals
                    clone.children[i+1].children[0].checked = false;                                                    // +1 to skip step # div
                }
                for (var i = 0; i < 10; i++){                                                                           // Reset speed and analog signals
                    clone.children[i+1+8].children[0].value = "0";                                                      // +1 to skip step # div
                }
            }

            var original_data = document.getElementById("form_data");                                               // Clone form data from step_0
            var clone_data = original_data.cloneNode(true);
            clone_data.setAttribute("name","step_" + (count - 1) + "_data");

            clone_data.value = "00000000000000000000000000000000000000";                                            // Reset data to zeros

            original_data.parentNode.appendChild(clone_data);                                                       // Add cloned inputs to HTML page
        
            document.getElementById(clone.id).children[0].textContent = clone.id;
        }
    }

    function remove_step(){
        var count = document.getElementById("step_inputs").children.length;                                         // CHeck the number of steps in the HTML page

        if (count > 2){                                                                                             // Leave at least one step on HTML page
            let input = document.getElementById("step_inputs");                                                     // Remove inputs
            input.removeChild(input.lastElementChild);

            let data = document.getElementById("my_form");                                                          // Remove step data
            data.removeChild(data.lastChild);   
        }
    }

    function update_program_number(selectObject){
        limit_input(selectObject, 2);

        var program_number = document.getElementById("program_ui").value;
        if (program_number == "") return;
        var raw_program_numer = program_number;
        document.getElementById("program").value = program_number;
        document.getElementById("program_submit").value = program_number;
        document.getElementById("program_number_delete").value = program_number;
        // if program # exists then submit
        // alert if loading program, data will be lost
        if (program_number.length == 1) program_number = '0' + program_number + '-';
        else program_number = program_number + '-';
        if (document.getElementById("program_list").value.includes(program_number)){
            if (confirm("Load program " + raw_program_numer + "? Current data inputs will be lost")){
                document.getElementById("program_load").submit();
            }
            else document.getElementById("program_ui").value = "";
        }
    }

    function update_program_speed(selectObject){
        limit_input(selectObject, 4);

        var program_speed = document.getElementById("speed_ui").value;
        document.getElementById("speed").value = program_speed;
    }

    function delete_program(){
        var program_number = document.getElementById("program_ui").value;
        var raw_program_number = program_number;
        var file_list = document.getElementById("program_list").value;
        if (program_number.length == 1) program_number = '0' + program_number + '-';
        else program_number = program_number + '-';
        if (document.getElementById("program_list").value.includes(program_number)){
            if (confirm("Delete program " + raw_program_number +"?")){
                document.getElementById("program_number_delete").value = document.getElementById("program").value;
                document.getElementById("delete_form").submit();

                var file_list = file_list.replace(program_number, "");
                document.getElementById("program_list").value = file_list;
            }
        }
    }

    window.addEventListener("load", page_load());
    function page_load(){
        console.log("page fully loaded");
        document.getElementById("page_name").style.visibility = "visible";
        }

    function limit_break(selectObject){
        let max_length = 3;
        var val = selectObject.value;
        if (String(val).length > max_length - 1) {
            selectObject.value = parseFloat(selectObject.value).toFixed(max_length-2);
        }
        if (val < 4) selectObject.value = 0;
        else if (val > 20) selectObject.value = 20;
    }

    function limit_input(selectObject, max_length){
        selectObject.value = parseFloat(selectObject.value).toFixed(0);
        var val = selectObject.value;
        if (String(val).length > max_length) {
            var x;
            if (max_length == 2) x = 100;
            else if (max_length == 4) x = "10 000";
            alert("Enter a number less than " + x);
            selectObject.value = "";
        }
        else if (val <= 0 && max_length == 4){
            alert("Enter a speed greater than 0");
            selectObject.value = "";
        }
        else if (val < 0 && max_length == 2){
            alert("Enter program number between 0 - 99");
            selectObject.value = "";
        }
    }

    // function map_value(x, in_min, in_max, out_min, out_max){
    function map_value(x){
        let in_min = 4;
        let in_max = 20;
        let out_min = 41;
        let out_max = 242;
        if (x < 4) return "000";
        else if (x == 4) return "041";                       // String(out_min)
        var val_map = (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
        val_map = val_map.toFixed(0);
        val_map = String(val_map);
        var val = "";
        if (val_map.length == 3) val = val_map;
        else if (val_map.length == 2){
            val = val.concat("0");
            val = val.concat(val_map[0]);
            val = val.concat(val_map[1]);
        }
        else if (val_map.length == 1){
            val = val.concat("0");
            val = val.concat("0");
            val = val.concat(val_map[0]);
        }
        return val;
    }
</script>
</body>
</html>