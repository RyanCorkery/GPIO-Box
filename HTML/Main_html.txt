<html>
<head>
<meta http-equiv="Content-Language" content="nl">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<title>GPIO Box REV 2</title>
<style>
body{
    display: flex;
    flex-direction: column;
}
h1 { 
    text-align: center;
    border-bottom: 2px solid darkslategray;
}
.grid-container{
    padding: 15px;
    display: grid;
    justify-content: start;
    grid-gap: 10px;
    grid-template-columns: auto;
}
.grid-container > div{
    display: grid;
    grid-auto-flow: column;
    justify-content: left;
}
.labels > div{
    padding: 5px;
    width: 70px;
    height: 20px;
}
.step{
    border-left: 1px solid cadetblue;
}
.step_label, #step_title{
    border-bottom: 2px solid gray;
}
.step > div{
    margin: 0 0 0 0;
    padding: 5px;
    height: 20px;
    width: auto;
}
.step_label{
    text-align: center;
}
.step > div > input{
    width: 35px;
    margin: auto;
}
#my_form{
    display: flex;
    flex-direction: column;
}
#form_data{
    width: 500px;;
}
.step_button{
    width: 200px;
    margin: 5px;
}
.hidden{
    visibility: hidden;
}
.program{
    margin: 5px;
}
#program_ui{
    margin-left: 10px;
    width: 30px;
}
#speed_ui{
    margin-left: 22px;
    width: 50px;
}
.step_label{
    margin-left: 15px;
}
#description{
    margin: 5px;
    display: flex;
    width: auto;
}
</style>
</head>


<body>

<h1>GPIO BOX REV 2</h1>

<form id="list_form" method="post" action="/">
    <input type="submit" name="list_form" value="Click to view the list of saved programs">
</form>

<iframe name="program_iframe" style="display: none;"></iframe>
<form id="program_load" method="post" action="/" target="program_iframe" style="display: none;">
    <input type="text" value="" id="program_submit">
    <input type="submit">
</form>

<div class="grid-container">
    <div class="program">Program Number: <input id="program_ui" value="" onchange="update_program_number()"></div>
    <div class="program">Program Speed:  <input id="speed_ui" value="" onchange="update_program_speed()"></div>
    <div id="step_inputs">
        <div class="Labels">
            <div id="step_title">Step #</div>
            <div>Break 1</div>
            <div>Break 2</div>
            <div>Break 3</div>
            <div>Break 4</div>
            <div>Break 5</div>
            <div>Break 6</div>
            <div>Break 7</div>
            <div>Break 8</div>
            <div>Speed 1</div>
            <div>Speed 2</div>
            <div>Speed 3</div>
            <div>Speed 4</div>
            <div>Speed 5</div>
            <div>Speed 6</div>
            <div>Speed 7</div>
            <div>Speed 8</div>
            <div>Analog 1</div>
            <div>Analog 2</div>
        </div>
        <div id="step_0" class="step">
            <div class="step_label">0</div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="checkbox"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
            <div><input type="text" value="0"></div>
        </div>
    </div>
</div>

<input class="step_button" type="button" value="Add Step" onclick="add_step()">
<input class="step_button" type="button" value="Remove Step" onclick="remove_step()"><br>

<iframe name="iframe1" style="display:none;"></iframe>
<form id="my_form" method="post" action="/" name="pins" target="iframe1" onsubmit="save_data()">
    Program description:<input type="text" value="" id="description" name="description" maxlength="100">Limit 100 characters<br>
    <input class="step_button" type="submit" value="Save program">
    <input type="text" id="program" class="hidden" name="program">
    <input type="text" id="speed" class="hidden" name="speed">
    <input id="form_data" type="text" name="step_0_data" value="00000000000000000000000000000000000000" class="hidden">
</form>

<input type="text" id="program_list" class="hidden">

<script>
    function save_data(){
        var number_of_steps = document.getElementById("step_inputs").children.length - 1;                           // Count number of steps in program

        var inputs = document.getElementById("step_inputs");                                                        // Count number of checkboxes in HTML page (break / speed / analog inputs)
        inputs = inputs.getElementsByTagName("input");
        var value;                                                                                                  // Store the checkbox/speed signal value

        for (var x = 0; x < number_of_steps; x++){                                                                  // Loop through steps// var original = document.getElementById("my_form").children[x+2].value; 
            var current_data = "00000000000000000000000000000000000000";
            for (var i = 0; i < 8; i++) {                                                                           // Loop through break checkboxes in each step
                if (inputs[i+x*18].type === 'checkbox') {
                    if (inputs[i+x*18].checked){                                                                    // If checked = true, update from step data
                        value = inputs[i+x*18].value;    
                        current_data = replaceChar(current_data, '1', i);
                    }   
                }
            }
            for (var i = 0; i < 10; i++) {                                                                          // Loop through speed and analog text boxes in each step
                if (inputs[i+x*18+8].type === 'text') {
                    value = inputs[i+x*18+8].value;                                                                 // Save text box value
                    
                    for (var n = 2; n>=0; n--){                                                                     // Check each digit of value (0 - 255)
                        if (value[n]){                                                                              // If digit exists, update step data string
                            current_data = replaceChar(current_data, value[n], i*3+8+n);
                        }
                    }
                }
            }
            document.getElementById("my_form").children[x+5].value = current_data;
        }
    }

    function replaceChar(origString, replaceChar, index) {
        let firstPart = origString.substr(0, index);
        let lastPart = origString.substr(index + 1);
        
        let newString = firstPart + replaceChar + lastPart;
        return newString;
    }

    function add_step(){
        var count = document.getElementById("step_inputs").children.length;                                         // Check the number of steps in the HTML page

        if (count <= 20){                                                                                           // 20 = max steps allowed. Could change but will also have to change arduino code
            var original = document.getElementById("step_0");                                                       // Clone step inputs from step_0
            var clone = original.cloneNode(true);
            clone.id = count - 1;
            original.parentNode.appendChild(clone);                                                                 // Appned cloned step to the end of step inputs div

            for (var i = 0; i < 8; i++){                                                                            // Reset break input signals
                clone.children[i+1].children[0].checked = false;                                                    // +1 to skip step # div
            }
            for (var i = 0; i < 10; i++){                                                                           // Reset speed and analog signals
                clone.children[i+1+8].children[0].value = "0";                                                      // +1 to skip step # div
            }

            var original_data = document.getElementById("form_data");                                               // Clone form data from step_0
            var clone_data = original_data.cloneNode(true);
            // clone.id = "";
            clone_data.setAttribute("name","step_" + (count - 1) + "_data");

            clone_data.value = "00000000000000000000000000000000000000";                                            // Reset data to zeros

            original_data.parentNode.appendChild(clone_data);                                                       // Add cloned inputs to HTML page
        
            document.getElementById(clone.id).children[0].textContent = clone.id;
        }
    }

    function remove_step(){
        var count = document.getElementById("step_inputs").children.length;                                         // CHeck the number of steps in the HTML page

        if (count > 2){                                                                                             // Leave at least one step on HTML page
            let input = document.getElementById("step_inputs");                                                     // Remove inputs
            input.removeChild(input.lastChild);

            let data = document.getElementById("my_form");                                                          // Remove step data
            data.removeChild(data.lastChild);   
        }
    }

    function update_program_number(){
        var program_number = document.getElementById("program_ui").value;
        document.getElementById("program").value = program_number;
        document.getElementById("program_submit").value = program_number;
        document.getElementById("program_load").submit();
    }

    function update_program_speed(){
        var program_speed = document.getElementById("speed_ui").value;
        document.getElementById("speed").value = program_speed;
    }

    function load_list(){
        var list = document.getElementById("program_list").value;
        window.open("list.html?variable=" + list, "_self");
    }
</script>
</body>
</html>